@using Drawer.Contract.InventoryManagement
@using Drawer.Contract.Locations
@using Drawer.Web.Api.InventoryManagement
@using Drawer.Web.Authentication
@using Drawer.Web.Pages.Item.Models
@using Drawer.Web.Services
@using Drawer.Web.Utils
@using Drawer.Web.Pages.Location.Models;

@attribute [Route(Paths.LocationBatchEdit)]

<CascadingValue IsFixed="true" Value="this">
    <BatchEdit TitleText="위치 일괄 추가"
               TModel="LocationModel"
               HomePath="@Paths.LocationHome"
               ExcelFormName="위치-양식"
               SaveAsyncFunc="@Save"
               ExcelOptions="@_excelOptions" >
        <HeaderRow>
            <MudTh Style="min-width:100px;">이름</MudTh>
            <MudTh Style="min-width:100px;">비고</MudTh>
            <MudTh Style="min-width:100px;">상위 위치</MudTh>
        </HeaderRow>
        <BodyRow>
            <MudTd>
                <AidInput @bind-Value="context.Name"
                          ExecuteInitialValidation="true"
                          Validation="@((_) => ValidateProperty(context, nameof(LocationModel.Name)))" />
            </MudTd>
            <MudTd>
                <AidInput @bind-Value="context.Note"
                          Validation="@((_) => ValidateProperty(context, nameof(LocationModel.Note)))" />
            </MudTd>
            <MudTd>
                <AidCompleteInput TKey="long"
                                  DisableUnderLine="true"
                                  ItemValues="@(_locations.Select(x=> x.Name).ToList())"
                                  @bind-Key="context.UpperLocationId"
                                  @bind-Value="context.UpperLocationName"
                                  KeyFunc="@((value) => _locations.FirstOrDefault(x=> x.Name == value)?.Id ?? 0)"
                                  Validation="@((_) => ValidateProperty(context, nameof(LocationModel.UpperLocationName)))" />
            </MudTd>
        </BodyRow>
    </BatchEdit>
</CascadingValue>
@code {
    private readonly LocationModelValidator _validator = new();
    private readonly ExcelOptions _excelOptions = new ExcelOptionsBuilder()
        .AddColumn(nameof(LocationModel.Name), "이름")
        .AddColumn(nameof(LocationModel.Note), "비고")
        .AddColumn(nameof(LocationModel.UpperLocationName), "상위 위치")
        .Build();

    [Inject] public LocationApiClient LocationApiClient { get; set; } = null!;
    [Inject] public ILockService LockService { get; set; } = null!;

    private List<GetLocationsResponse.Location> _locations = new List<GetLocationsResponse.Location>();

    protected override async Task OnInitializedAsync()
    {
        await GetLocations();
    }

    private List<IValidation> validations = new();
    internal void AddValidation(IValidation validation)
    {
        validations.Add(validation);
    }

    private async Task<Dictionary<string, long>> GetLocations()
    {
        var dict = await LockService.DoAsync<Dictionary<string, long>>(async () =>
        {
            var response = await LocationApiClient.GetLocations();

            var locationDict = new Dictionary<string, long>();
            if (Snackbar.CheckFail(response))
            {
                _locations.AddRange(response.Data.Locations.ToList());
                _validator.LocationNames = _locations.Select(x => x.Name).ToList();

                foreach (var location in response.Data.Locations)
                    locationDict[location.Name] = location.Id;
            }
            return locationDict;
        });
        return dict;
    }


    private async Task<bool> Save(IEnumerable<LocationModel> locations)
    {
        var content = new BatchCreateLocationRequest(locations.Select(x =>
            new BatchCreateLocationRequest.Location(x.UpperLocationId, x.Name!, x.Note)).ToList());

        var response = await LocationApiClient.BatchAddLocation(content);

        return Snackbar.CheckSuccessFail(response);
    }

    private string? ValidateProperty(LocationModel instance, string property)
    {
        var msg = _validator.ValidateProperty(instance, property);
        return msg;
    }
}




