@using Drawer.Contract.Locations
@using Drawer.Web.Api.Locations
@using Drawer.Web.Authentication
@using Drawer.Web.Pages.Items.Models
@using Drawer.Web.Services
@using Drawer.Web.Utils
@using Drawer.Web.Pages.Locations.Models;

@attribute [Route(Paths.SpotBatchEdit)]

<BatchEdit TitleText="자리 일괄 추가"
           TModel="SpotModel"
           HomePath="@Paths.SpotHome"
           ExcelFormName="자리-양식"
           SaveAsyncFunc="@Save"
           ExcelOptions="@_excelOptions"
           Validate="@Validate">

    <HeadRow>
        <MudTh Style="min-width:100px;">이름</MudTh>
        <MudTh Style="min-width:100px;">비고</MudTh>
        <MudTh Style="min-width:100px;">구역</MudTh>
    </HeadRow>
    <BodyRow>
        <AidInputCell @bind-Value="context.Name"
                      Validate="@((_) => ValidateProperty(context, nameof(SpotModel.Name)))" />

        <AidInputCell @bind-Value="context.Note"
                      Validate="@((_) => ValidateProperty(context, nameof(SpotModel.Note)))" />
        <AidCompleteInputCell TValue="long"
                              ItemDictFunc="GetZones"
                              Validate="@((_) => ValidateProperty(context, nameof(SpotModel.ZoneId)))"
                              @bind-Text="context.ZoneName"
                              @bind-Value="context.ZoneId" />
    </BodyRow>
</BatchEdit>

@code {
    private readonly SpotModelValidator _validator = new();
    private readonly ExcelOptions _excelOptions = new ExcelOptionsBuilder()
        .AddColumn(nameof(SpotModel.Name), "이름")
        .AddColumn(nameof(SpotModel.Note), "비고")
        .AddColumn(nameof(SpotModel.ZoneName), "구역")
        .Build();

    [Inject] public SpotApiClient SpotApiClient { get; set; } = null!;
    [Inject] public ZoneApiClient ZoneApiClient { get; set; } = null!;
    [Inject] public ILockService LockService { get; set; } = null!;

    protected override async Task OnInitializedAsync()
    {
        await GetZones();
    }

    private async Task<Dictionary<string, long>> GetZones()
    {
        var dict = await LockService.DoAsync<Dictionary<string, long>>(async () =>
        {
            var zoneResponse = await ZoneApiClient.GetZones();

            var zoneDict = new Dictionary<string, long>();
            if (Snackbar.CheckFail(zoneResponse))
            {
                foreach (var Zone in zoneResponse.Data.Zones)
                    zoneDict[Zone.Name] = Zone.Id;
            }
            return zoneDict;
        });
        return dict;
    }


    private async Task<bool> Save(IEnumerable<SpotModel> spots)
    {

        bool success = true;
        foreach (var Spot in spots)
        {
            var content = new CreateSpotRequest(Spot.ZoneId, Spot.Name, Spot.Note);
            var response = await SpotApiClient.AddSpot(content);
            success &= Snackbar.CheckSuccessFail(response);
        }
        return success;

    }

    private bool Validate(SpotModel instance)
    {
        var result = _validator.Validate(instance);
        return result.IsValid;
    }

    private string? ValidateProperty(SpotModel instance, string property)
    {
        var msg = _validator.ValidateProperty(instance, property);
        return msg;
    }
}




